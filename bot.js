const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
const path = require('path');

const BOT_TOKEN = '7411071202:AAFgoExnRZ1Dd6jt0-34Jzcn2ODDq2A8ah8';
const CHANNEL_CHAT_ID = '-1001513121427';

const bot = new TelegramBot(BOT_TOKEN, { polling: true });
const app = express();
const PORT = process.env.PORT || 3000;

// ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
async function checkSubscription(userId) {
  try {
    const member = await bot.getChatMember(CHANNEL_CHAT_ID, userId);
    return ['creator', 'administrator', 'member'].includes(member.status);
  } catch (error) {
    console.log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:', error);
    return false;
  }
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð° Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ
async function sendResearchFile(chatId, userName) {
  try {
    // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
    const message = await bot.sendMessage(chatId, `ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ ${userName}...`);

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ
    // Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð• Ð¡Ð¡Ð«Ð›ÐšÐ£ ÐÐ ÐÐšÐ¢Ð£ÐÐ›Ð¬ÐÐ«Ð™ Ð¤ÐÐ™Ð›!
    const fileUrl = 'https://disk.yandex.ru/i/oYrx4_AJfiS1BQ'; // Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð• Ð­Ð¢Ð£ Ð¡Ð¡Ð«Ð›ÐšÐ£
    
    await bot.sendDocument(chatId, fileUrl, {
      caption: `ðŸ“Š Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ ${userName}\n\n` +
               `Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð²Ð°ÑˆÐµÐ¼Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ.\n` +
               `Ð•ÑÐ»Ð¸ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ½ÑƒÑ‚ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ - Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð¹Ñ‚ÐµÑÑŒ!`
    });

    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
    await bot.deleteMessage(chatId, message.message_id);

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    await bot.sendMessage(chatId,
      `âœ… Ð¤Ð°Ð¹Ð» ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½, ${userName}!\n\n` +
      `ðŸ“– *Ð§Ñ‚Ð¾ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ:*\n` +
      `â€¢ ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ñ€Ñ‹Ð½ÐºÐ°\n` +
      `â€¢ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸\n` +
      `â€¢ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… ÐºÐµÐ¹ÑÐ¾Ð²\n` +
      `â€¢ ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸\n\n` +
      `ðŸ’¡ *Ð¡Ð¾Ð²ÐµÑ‚:* Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ!`,
      { parse_mode: 'Markdown' }
    );

  } catch (error) {
    console.log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°:', error);
    await bot.sendMessage(chatId,
      `âŒ ${userName}, Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°.\n` +
      `ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹.`
    );
  }
}

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const userName = msg.from.first_name || 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ';

  console.log(`ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° /start Ð¾Ñ‚ ${userName} (${userId})`);

  try {
    if (await checkSubscription(userId)) {
      await bot.sendMessage(chatId, 
        `âœ… ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${userName}! Ð’Ñ‹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð½Ð° ÐºÐ°Ð½Ð°Ð»! Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ!\n\n` +
        `ðŸ“š *Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ð°Ð¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾:*\n` +
        `â€¢ Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€Ñ‹Ð½ÐºÐ°\n` +
        `â€¢ ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹\n` +
        `â€¢ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹\n\n` +
        `â¬‡ï¸ *ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ Ñ„Ð°Ð¹Ð» Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ...*`,
        { parse_mode: 'Markdown' }
      );
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ
      await sendResearchFile(chatId, userName);
      
    } else {
      const keyboard = {
        inline_keyboard: [
          [{ text: 'ðŸ“¢ ÐŸÐžÐ”ÐŸÐ˜Ð¡ÐÐ¢Ð¬Ð¡Ð¯ ÐÐ ÐšÐÐÐÐ›', url: 'https://t.me/uleymp' }],
          [{ text: 'âœ… Ð¯ ÐŸÐžÐ”ÐŸÐ˜Ð¡ÐÐ›Ð¡Ð¯', callback_data: 'check_sub' }]
        ]
      };
      
      await bot.sendMessage(chatId, 
        `âš ï¸ ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${userName}! Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð» @uleymp\n\n` +
        `*ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ:*\n` +
        `ðŸ“Š ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€Ñ‹Ð½ÐºÐ°\n` +
        `ðŸ“ˆ ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n` +
        `ðŸ’¡ ÐŸÑ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸\n\n` +
        `ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:`,
        { reply_markup: keyboard, parse_mode: 'Markdown' }
      );
    }
  } catch (error) {
    console.log('ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
    await bot.sendMessage(chatId, 'âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸
bot.on('callback_query', async (query) => {
  const userId = query.from.id;
  const userName = query.from.first_name || 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ';
  const chatId = query.message.chat.id;

  console.log(`ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¾Ñ‚ ${userName} (${userId})`);

  if (query.data === 'check_sub') {
    try {
      if (await checkSubscription(userId)) {
        // Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        await bot.editMessageText(
          `âœ… ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾, ${userName}! Ð’Ñ‹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð½Ð° ÐºÐ°Ð½Ð°Ð»!\n\n` +
          `ðŸ“¥ *Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ...*`,
          {
            chat_id: chatId,
            message_id: query.message.message_id,
            parse_mode: 'Markdown'
          }
        );

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ
        await sendResearchFile(chatId, userName);

      } else {
        await bot.answerCallbackQuery(query.id, {
          text: `âŒ ${userName}, Ð²Ñ‹ ÐµÑ‰Ðµ Ð½Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð½Ð° ÐºÐ°Ð½Ð°Ð»! ÐŸÐ¾Ð´Ð¿Ð¸ÑˆÐ¸Ñ‚ÐµÑÑŒ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`,
          show_alert: true
        });
      }
    } catch (error) {
      console.log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÐºÐ½Ð¾Ð¿ÐºÐ¸:', error);
      await bot.answerCallbackQuery(query.id, {
        text: 'âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ',
        show_alert: true
      });
    }
  }
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‡Ð¸ÐºÐ¾Ð²)
bot.onText(/\/research/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const userName = msg.from.first_name || 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ';

  try {
    if (await checkSubscription(userId)) {
      await sendResearchFile(chatId, userName);
    } else {
      await bot.sendMessage(chatId,
        `âŒ ${userName}, Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð» @uleymp\n\n` +
        `Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸.`
      );
    }
  } catch (error) {
    console.log('ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /research:', error);
  }
});

// Ð”Ð»Ñ Render
app.get('/', (req, res) => {
  res.send('ðŸ¤– Telegram Bot is running!');
});

app.listen(PORT, () => {
  console.log(`ðŸš€ Bot started on port ${PORT}`);
});

console.log('âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!');
